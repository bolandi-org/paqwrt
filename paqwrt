#!/bin/sh
# PAQWRT - Professional Paqet Manager for OpenWrt
# Version: 2.2.0 (Stable Core - Based on v1.7.2 Logic)
# Repository: https://github.com/bolandi-org/paqwrt

# --- Global Variables ---
INSTALL_DIR="/usr/bin"
CONF_DIR="/etc/paqet"
CONF_FILE="$CONF_DIR/config.yaml"
SERVICE_FILE="/etc/init.d/paqet"
BINARY_PATH="$INSTALL_DIR/paqet"
REPO_OWNER="hanselime"
REPO_NAME="paqet"

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# --- Helper Functions ---

ask_value() {
    local prompt="$1"
    local default="$2"
    local var_name="$3"
    local input
    printf "${CYAN}${prompt} ${NC}[Default: ${GREEN}${default}${NC}]: "
    read -r input
    if [ -z "$input" ]; then
        eval $var_name=\"$default\"
    else
        eval $var_name=\"$input\"
    fi
}

get_latest_version() {
    curl -sL --retry 3 "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases/latest" | \
    grep -o '"tag_name":[ ]*"[^"]*"' | head -n 1 | sed 's/"tag_name":[ ]*"//;s/"//'
}

# --- Core Logic ---

install_dependencies() {
    echo -e "${YELLOW}Checking dependencies...${NC}"
    local deps="libpcap curl ca-bundle kmod-nft-bridge ethtool"
    local missing=""
    for dep in $deps; do
        if ! opkg list-installed | grep -q "^$dep"; then
            missing="$missing $dep"
        fi
    done
    if [ -n "$missing" ]; then
        opkg update > /dev/null 2>&1
        opkg install $missing
    fi
    # Fix libraries
    [ ! -f /lib/ld-linux-aarch64.so.1 ] && ln -sf /lib/ld-musl-aarch64.so.1 /lib/ld-linux-aarch64.so.1 2>/dev/null
    [ ! -f /usr/lib/libpcap.so.1 ] && ln -sf /usr/lib/libpcap.so.1.0 /usr/lib/libpcap.so.1 2>/dev/null
}

update_core() {
    install_dependencies
    echo -e "${YELLOW}Fetching latest version...${NC}"
    LATEST_TAG=$(get_latest_version)
    if [ -z "$LATEST_TAG" ]; then echo -e "${RED}Failed to check version.${NC}"; return 1; fi
    
    echo -e "Version: ${GREEN}$LATEST_TAG${NC}"
    ARCH=$(uname -m)
    case "$ARCH" in
        x86_64) BIN_ARCH="amd64" ;;
        aarch64|arm64) BIN_ARCH="arm64" ;;
        armv*) BIN_ARCH="arm32" ;;
        mips64) [ "$(echo -n I | od -to2 | awk '{print $2}' | cut -c1)" = "0001" ] && BIN_ARCH="mips64le" || BIN_ARCH="mips64" ;;
        mips*) [ "$(echo -n I | od -to2 | awk '{print $2}' | cut -c1)" = "0001" ] && BIN_ARCH="mipsle" || BIN_ARCH="mips" ;;
        *) echo -e "${RED}Arch $ARCH not supported${NC}"; return 1 ;;
    esac

    DOWNLOAD_URL="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/$LATEST_TAG/paqet-linux-$BIN_ARCH-$LATEST_TAG.tar.gz"
    echo -e "${BLUE}Downloading...${NC}"
    curl -L --retry 3 "$DOWNLOAD_URL" -o "/tmp/paqet.tar.gz"
    
    if [ $? -eq 0 ] && [ -s "/tmp/paqet.tar.gz" ]; then
        tar -xzf "/tmp/paqet.tar.gz" -C "/tmp"
        NEW_BIN=$(find /tmp -type f \( -name "paqet" -o -name "paqet_linux_*" \) | head -n 1)
        if [ -n "$NEW_BIN" ]; then
            $SERVICE_FILE stop 2>/dev/null
            mv "$NEW_BIN" "$BINARY_PATH"
            chmod +x "$BINARY_PATH"
            rm "/tmp/paqet.tar.gz"
            echo -e "${GREEN}Updated successfully.${NC}"
        else
            echo -e "${RED}Binary not found in archive.${NC}"
        fi
    else
        echo -e "${RED}Download failed.${NC}"
    fi
}

configure_paqet() {
    clear
    echo -e "${BLUE}=======================================${NC}"
    echo -e "${BOLD}     PAQWRT CONFIG (Stable Core)       ${NC}"
    echo -e "${BLUE}=======================================${NC}"
    
    printf "Enter Server ${YELLOW}IP:PORT${NC}: "
    read -r SERVER_ADDR
    [ -z "$SERVER_ADDR" ] && return
    
    printf "Enter ${YELLOW}Encryption Key${NC}: "
    read -r SECRET_KEY
    [ -z "$SECRET_KEY" ] && return

    echo -e "\n${BOLD}Mode:${NC}"
    echo -e "1) ${GREEN}Default${NC} (Conn:1, Interval:10)"
    echo -e "2) ${YELLOW}Manual${NC}"
    printf "Select [1]: "
    read -r mode_choice

    # Base Defaults
    DEF_CONN=1; DEF_MTU=1350; DEF_SNDWND=350; DEF_RCVWND=450;
    DEF_INTERVAL=10; DEF_NODELAY=1; DEF_RESEND=2; DEF_NOCONGESTION=1

    if [ "$mode_choice" = "2" ]; then
        echo -e "\n${CYAN}--- Manual Settings ---${NC}"
        ask_value "Connections" "6" "CONF_CONN"
        ask_value "MTU" "$DEF_MTU" "CONF_MTU"
        ask_value "Interval" "$DEF_INTERVAL" "CONF_INTERVAL"
        ask_value "SndWnd" "$DEF_SNDWND" "CONF_SNDWND"
        ask_value "RcvWnd" "$DEF_RCVWND" "CONF_RCVWND"
        ask_value "NoDelay" "$DEF_NODELAY" "CONF_NODELAY"
        ask_value "Resend" "$DEF_RESEND" "CONF_RESEND"
        ask_value "NoCongestion" "$DEF_NOCONGESTION" "CONF_NOCONGESTION"
    else
        CONF_CONN=$DEF_CONN; CONF_MTU=$DEF_MTU; CONF_INTERVAL=$DEF_INTERVAL
        CONF_SNDWND=$DEF_SNDWND; CONF_RCVWND=$DEF_RCVWND; CONF_NODELAY=$DEF_NODELAY
        CONF_RESEND=$DEF_RESEND; CONF_NOCONGESTION=$DEF_NOCONGESTION
        echo -e "${GREEN}Using defaults.${NC}"
    fi

    # --- NETWORK DETECTION (STATIC - Like v1.7.2) ---
    echo -e "${YELLOW}Detecting Network...${NC}"
    WAN_INT=$(ip route show default | awk '/default/ {print $5}' | head -n1)
    WAN_IP=$(ip -4 addr show "$WAN_INT" | grep -oE '\d+(\.\d+){3}' | head -n 1)
    GW_IP=$(ip route show default | awk '/default/ {print $3}' | head -n1)
    ROUTER_MAC=$(ip neigh show "$GW_IP" | awk '{print $5}' | grep -oE '([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}')
    
    if [ -z "$WAN_IP" ]; then echo -e "${RED}Failed to detect WAN IP.${NC}"; return; fi

    # --- PORT LOGIC (The Fix) ---
    # If connections > 1, force port 0 (random)
    if [ "$CONF_CONN" -gt 1 ]; then
        LOCAL_ADDR="$WAN_IP:0"
    else
        LOCAL_ADDR="$WAN_IP:55555"
    fi

    mkdir -p "$CONF_DIR"
    
    # WRITE CONFIG ONCE (Clean YAML)
    cat <<EOC > "$CONF_FILE"
role: "client"
log:
  level: "error"
socks5:
  - listen: "0.0.0.0:1080"
network:
  interface: "$WAN_INT"
  ipv4:
    addr: "$LOCAL_ADDR"
    router_mac: "$ROUTER_MAC"
server:
  addr: "$SERVER_ADDR"
transport:
  protocol: "kcp"
  conn: $CONF_CONN
  kcp:
    mode: "manual"
    nodelay: $CONF_NODELAY
    interval: $CONF_INTERVAL
    resend: $CONF_RESEND
    nocongestion: $CONF_NOCONGESTION
    mtu: $CONF_MTU
    sndwnd: $CONF_SNDWND
    rcvwnd: $CONF_RCVWND
    key: "$SECRET_KEY"
EOC

    create_init_script
    echo -e "${GREEN}Configuration saved.${NC}"
    
    # Apply Firewall Immediately
    apply_firewall_rules
    
    /etc/init.d/paqet restart
    echo -e "${GREEN}Service restarted.${NC}"
}

apply_firewall_rules() {
    # Extract Server IP from config for firewall matching
    if [ ! -f "$CONF_FILE" ]; then return; fi
    
    # Better extraction logic
    SERVER_LINE=$(grep -A 2 "server:" $CONF_FILE | grep "addr:")
    S_FULL=$(echo $SERVER_LINE | awk '{print $2}' | tr -d '"')
    S_IP=$(echo $S_FULL | cut -d: -f1)
    S_PORT=$(echo $S_FULL | cut -d: -f2)

    if [ -z "$S_IP" ] || [ -z "$S_PORT" ]; then return; fi

    echo -e "${CYAN}Applying Firewall Rules (Target: $S_IP)...${NC}"
    nft delete table inet paqet_rules 2>/dev/null || true
    nft add table inet paqet_rules
    nft add chain inet paqet_rules prerouting { type filter hook prerouting priority -300 \; }
    nft add chain inet paqet_rules output { type filter hook output priority -300 \; }
    nft add chain inet paqet_rules forward { type filter hook forward priority -150 \; }
    
    # MSS Clamping
    nft add rule inet paqet_rules forward tcp flags syn tcp option maxseg size set 1300
    
    # Bypass Conntrack (Match Server IP/Port)
    nft add rule inet paqet_rules prerouting ip saddr $S_IP tcp sport $S_PORT notrack
    nft add rule inet paqet_rules output ip daddr $S_IP tcp dport $S_PORT notrack
    nft add rule inet paqet_rules output ip daddr $S_IP tcp dport $S_PORT tcp flags rst drop
}

create_init_script() {
    # Simple Init Script - Just runs the binary (No magic modification)
    cat << 'EoS' > $SERVICE_FILE
#!/bin/sh /etc/rc.common
START=99
USE_PROCD=1

start_service() {
    procd_open_instance
    procd_set_param command /usr/bin/paqet run -c /etc/paqet/config.yaml
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param respawn 3600 5 0
    procd_close_instance
}

stop_service() {
    # Cleanup firewall on stop
    nft delete table inet paqet_rules 2>/dev/null
}
EoS
    chmod +x $SERVICE_FILE
    $SERVICE_FILE enable
}

# --- Main Menu ---

show_menu() {
    clear
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║          PAQWRT MANAGER v2.2.0 - Stable Edition               ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════╝${NC}"
    echo -e "1) ${GREEN}Install / Update Core${NC}"
    echo -e "2) ${YELLOW}Configure / Modify Settings${NC}"
    echo -e "3) Start Service"
    echo -e "4) Stop Service"
    echo -e "5) Restart Service"
    echo -e "6) Show Logs"
    echo -e "7) ${RED}Uninstall${NC}"
    echo -e "0) Exit"
    printf "Select option: "
    read -r opt
    case $opt in
        1) update_core; read -p "Press Enter..." ;;
        2) install_dependencies; configure_paqet; read -p "Press Enter..." ;;
        3) apply_firewall_rules; $SERVICE_FILE start; echo "Started."; read -p "Press Enter..." ;;
        4) $SERVICE_FILE stop; echo "Stopped."; read -p "Press Enter..." ;;
        5) apply_firewall_rules; $SERVICE_FILE restart; echo "Restarted."; read -p "Press Enter..." ;;
        6) logread | grep paqet | tail -n 20; read -p "Press Enter..." ;;
        7) $SERVICE_FILE stop; $SERVICE_FILE disable; rm -rf $CONF_DIR $SERVICE_FILE $INSTALL_DIR/paqet /usr/bin/paqwrt; nft delete table inet paqet_rules 2>/dev/null; echo "Uninstalled."; exit 0 ;;
        0) exit 0 ;;
        *) echo "Invalid option"; sleep 1 ;;
    esac
}

if [ "$(id -u)" != "0" ]; then echo "Error: Must run as root!"; exit 1; fi

if [ "$1" = "install" ]; then
    TARGET_PATH="/usr/bin/paqwrt"
    update_core
    if [ -f "$0" ] && grep -q "PAQWRT" "$0" 2>/dev/null; then cp "$0" "$TARGET_PATH"; fi
    if [ ! -s "$TARGET_PATH" ]; then curl -L "https://raw.githubusercontent.com/bolandi-org/paqwrt/main/paqwrt" > "$TARGET_PATH"; fi
    chmod +x "$TARGET_PATH"
    echo -e "${GREEN}Paqwrt installed successfully! Run 'paqwrt' to start.${NC}"
else
    while true; do show_menu; done
fi
